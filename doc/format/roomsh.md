# Rooms.h 格式

Rooms.h格式是一个使用很久，范围很广的类ini格式语法的房间出口信息文件格式。

HMM支持导入和导出Rooms.h格式的房间信息信息文件，并作了一定的扩展

## 基本语法

Rooms.h支持一行一个房间，房间信息包含基本信息和出口信息的格式。

文件编码取决于使用的脚本，不含BOM头。

经HMM扩展支持空行和空格+//开头的注释。

有效信息每行一个房间，格式如下

```
房间ID=房间名@房间区域+房间标签1+房间标签2|标签>排除标签<指令:出口信息1$路径消耗,标签2>排除标签2<指令2:出口ID2$路径消耗
```

* 所有信息会去除行前空格
* 每行中使用的特殊Token包括 "=","@","+","|",">","<",",","$"
* 房间ID为比选项，并且唯一。房间无效ID则当前行当作无效信息处理。*和？作为保留房间名，正常不应该使用。
* 房间名，房间区域，房间标签都可为空
* 标签和出口标签可为空。标签和出口标签如果值为空，则无效(不允许空标签使用)
* 指令不可为空，为空为无效出口
* 出口为必填。为空做为无效出口。为\*或者?作为保留未使用出口。原则上为\*代表出口不使用,为?代表出口还处于探索中
* 路径消耗目前只支持数字，代表地图计算时每一步的消耗，默认为1。如路径消耗不是有效数字，则作为1计算。

## 解析顺序
1. 行信息对回车\n做解转义。
2. 根据行信息，寻找"|"这个Token,将信息分为房间信息和出口信息两个部分。如未找到，所有信息作为房间信息。分离后的房间信息和出口信息数据，对"|"解转义。
3. 房间信息寻找"="Token,将信息分为房间ID和房间描述两个部分。没有"="为无效房间。
4. 房间描述寻找"@"Token,将信息分为房间ID和房间定义两个部分。如未找到，所有信息作为房间信息。分离后的房间信息和房间定义对"@"解转义。
5. 房间定义用"+"Token做字符串分割。第一个字符串(可为空)为房间区域，剩下的为房间标签。分离后的房间信息和房间定义对"+"解转义。
6. 出口信息部分用","这个Token做字符串分割。分割后的每一个子字符串为有顺序的出口信息，并对","做解转义
7. 每个出口寻找":"Token,将出口分为指令和出口定义两个部分。如果没有出口定义，所有内容作为出口指令部分。
8. 指令部分用">"Token进行分割。分割后的的最后一个子字符串作为条件指令，其他的部分为路径标签。所有字符串对">"做解转义。
9. 条件指令对"<"进行分割(即所有的路径标签必须出现在排除标签之前),分割后的的最后一个子字符串作为实际指令，其他的部分为路径标签。所有字符串对"<"做解转义。
10. 出口定义寻找"$"这个Token,将信息分为出口房间和路径消耗两个部分。如未找到，所有信息作为出口房间。分离后的出口房间和路径消耗对"$"做解转义。
11. 解析完毕。

## 编码顺序
1. 遍历所有出口。
2. 每一个出口将出口房间和路径消耗,对"$"Token做转义。如果路径消耗不为1，使用"$"Token做拼接作为出口定义。否则使用出口房间作为出口定义。
3. 将排除条件和实际指令，对"<"做转义，保留顺序并使用"<"Token进行字符串拼接，作为条件指令。
4. 将路径标签和条件指令，对">"做转义，保留顺序并使用">"Token进行字符串拼接，作为指令。
5. 将指令和出口定义对":"Token进行转义。如果出口定义不为空，使用":"Token作为拼接作为出口。否这使用指令部分作为出口。
6. 将所有出口对","做转义，保留顺序并使用","Token进行字符串拼接，作为出口信息。
7. 将房间区域和房间标签对"+"做转义,保留瞬息并使用"+"进行字符串拼接，作为房间定义。
8. 将房间名和房间定义，对"@"做转义。如果房间定义不为空，使用"@"Token转义拼接作为房间描述。否则使用房间名作为房间描述。
9. 将房间ID和房间描述对"="做转义，并使用"="Token进行字符串评价，作为行信息
10. 行信息对回车\n做转义，并使用\n拼接。
11. 编码完成

## 转义指令
* "%" 转义为 %%
* \n 转义为 %0A
* "=" 转义为 %3D
* "@" 转义为 %40
* "+" 转义为 %2B
* "|" 转义为 %7C
* ">" 转义为 %3E
* "<" 转义为 %3C
* "," 转义为 %2C
* "$" 转义为 %24